{% extends "mobile/base.html" %}
{% block content %}
  <script>
    document.getElementById('page-title').textContent = 'Store: रोल एवं लोकेशन स्कैन';
    speak('Please Scan The Roll कृपया रोल स्कैन करें');
  </script>

  <p style="text-align:center; font-size:1rem; margin-bottom:1rem;">
    Scan rolls (batch), then rack location<br/>
    पहले रोल स्कैन करें, फिर रैक लोकेशन स्कैन करें
  </p>

  <!-- Scanner viewport -->
  <input id="kbd‐input" type="text" autocomplete="off"
    autocapitalize="off" autocorrect="off" spellcheck="false"
    style="position:absolute;top:-9999px;left:-9999px;"/>
  <div id="reader"></div>  
  

  <!-- List of scanned rolls -->
  <div class="list" style="margin-top:1em;">
    <h3>Rolls to store:<br/>स्टोर करने के लिए रोल</h3>
    <ul id="roll-list"></ul>
  </div>

  <!-- Button to switch to rack mode -->
  <button id="scan-location" class="btn" style="display:none; margin-top:1em;">
    Scan Location<br/>लोकेशन स्कैन करें
  </button>

  <script>
    function parseRollId(s) {
      try {
        if (s.startsWith('http')) {
          return new URL(s).pathname.split('/').filter(Boolean).pop();
        }
      } catch {}
      return s.trim();
    }

    const rolls = [];
    let locationMode = false;
    const listEl = document.getElementById('roll-list');
    const locBtn = document.getElementById('scan-location');

    async function handleDecode(raw) {
      console.log('[STORE] handleDecode called with:', raw);
      const id = parseRollId(raw);

      if (!locationMode) {
        console.log('[STORE] Batch mode, id=', id);
        if (rolls.includes(id)) {
          console.log('[STORE] Skipping duplicate roll:', id);
          return;
        }

        const ok = await fetch(`/api/rolls/${id}/`).then(r => r.ok);
        if (!ok) {
          console.warn('[STORE] Roll not found:', id);
          return alert(`❌ Roll "${id}" not found.\n❌ रोल "${id}" नहीं मिला।`);
        }

        

        rolls.push(id);
        const li = document.createElement('li');
        li.textContent = id;
        listEl.appendChild(li);
        speak(`रोल ${id.slice(0,8)} जोड़ा`);

        if (rolls.length === 1) {
          locBtn.style.display = 'block';
          console.log('[STORE] Showing Scan Location button');
        }

      } else {
        console.log('[STORE] Rack mode, committing', rolls.length, 'rolls');
        const location = parseRollId(raw);
        speak(`लोकेशन ${location} स्कैन किया गया`);

        for (const r of rolls) {
          console.log('[STORE] PUTAWAY', r, '→', location);
          const res = await fetch('/api/transactions/', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
              'Content-Type':'application/json',
              'X-CSRFToken': window.CSRF_TOKEN
            },
            body: JSON.stringify({ roll: r, action: 'PUTAWAY', location, user: window.CURRENT_USER })
          });
          if (!res.ok) {
            const err = await res.json().catch(()=>null);
            console.error('[STORE] PUTAWAY error', err);
            return alert(`❌ Error: ${JSON.stringify(err)}`);
          }
        }

        console.log('[STORE] All PUTAWAYs succeeded');
        alert(
          `✅ ${rolls.length} rolls stored at ${location}.\n` +
          `✅ ${rolls.length} रोल ${location} पर स्टोर किए गए।`
        );
        return location.reload();
      }
    }

    console.log('[STORE] Creating Html5Qrcode instance');
    const qr = new Html5Qrcode("reader");

    console.log('[STORE] Starting scanner...');
    qr.start(
      { facingMode:'environment' },
      { fps:10, qrbox:250 },
      handleDecode,
      err => console.warn('[STORE] decode error:', err)
    )
    .then(() => console.log('[STORE] scanner.start() resolved — camera should be live'))
    .catch(err => {
      console.error('[STORE] scanner startup error:', err);
      alert('कृपया कैमरा अनुमति दें');
    });

    locBtn.addEventListener('click', () => {
      console.log('[STORE] Scan Location button clicked — switching to rack mode');
      locationMode = true;
      speak('कृपया लोकेशन स्कैन करें');
      alert('Now scan rack location\nअब रैक लोकेशन स्कैन करें');
    });
    //  capture hardware‐scanner keystrokes
    let buffer = '';
    function handleKbd(evt) {
      if (evt.key.length === 1) buffer += evt.key;
      else if (evt.key === 'Enter' && buffer) {
        handleDecode(buffer);
        buffer = '';
        buffer = '';
      }
    }
    //  show/hide camera vs keyboard
    const cameraEl = document.getElementById('reader');
    const kbdInput = document.getElementById('kbd‐input');
    function updateScannerUI(mode) {
      if (mode === 'camera') {
        cameraEl.style.display = 'block';
        document.removeEventListener('keydown', handleKbd);
      } else {
        cameraEl.style.display = 'none';
        buffer = '';
        kbdInput.focus();
        document.addEventListener('keydown', handleKbd);
      }
    }

    // init & listen for toggles
    updateScannerUI(localStorage.getItem('scanMode') || 'camera');
    window.addEventListener('scanModeChanged', e => updateScannerUI(e.detail));
  </script>
{% endblock %}
