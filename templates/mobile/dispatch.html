{% extends "mobile/base.html" %}
{% block content %}
  <script>
    document.getElementById('page-title').textContent = 'Dispatch / рдЯреНрд░рд╛рдВрд╕рдлрд░';
    speak('рдХреГрдкрдпрд╛ рдПрдХ рдХреНрд░рд┐рдпрд╛ рдЪреБрдиреЗрдВ');
  </script>

  <p style="text-align:center; font-size:1rem; margin-bottom:1rem;">
    Choose action, scan rolls in batch<br/>
    рдкрд╣рд▓реЗ рдХреНрд░рд┐рдпрд╛ рдЪреБрдиреЗрдВ, рдлрд┐рд░ рд░реЛрд▓ рдмреИрдЪ рдореЗрдВ рд╕реНрдХреИрди рдХрд░реЗрдВ
  </p>

  <!-- 1) Action buttons -->
  <div style="text-align:center; margin-bottom:1rem;">
    <button id="to-customer" class="btn">ЁЯЪЪ Dispatch to Customer</button>
    <button id="to-dept"     class="btn secondary">ЁЯФД Transfer Dept</button>
  </div>

  <!-- 2a) Customer input -->
  <div id="cust-div" style="display:none; text-align:center; margin-bottom:1rem;">
    <input id="cust-input" type="text" placeholder="Customer name"
           style="width:80%; padding:.5rem;" />
  </div>

  <!-- 2b) Dept selector -->
  <div id="dept-div" style="display:none; text-align:center; margin-bottom:1rem;">
    <select id="dept-select" class="btn secondary"
            style="width:80%; padding:.5rem;">
      {% for d in departments %}
        <option value="{{ d.code }}">{{ d.code }} тАУ {{ d.name }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- 3) Scan Location button (only for TRANSFER) -->
  <button id="scan-location" class="btn secondary"
          style="display:none; margin-bottom:1rem;">
    Scan Location<br/>рд▓реЛрдХреЗрд╢рди рд╕реНрдХреИрди рдХрд░реЗрдВ
  </button>
  <input id="kbdтАРinput" type="text" autocomplete="off"
    autocapitalize="off" autocorrect="off" spellcheck="false"
    style="position:absolute;top:-9999px;left:-9999px;"/>
  <!-- 4) Scanner viewport -->
  <div id="reader"></div>

  <!-- 5) List scanned rolls -->
  <div class="list" style="margin-top:1rem;">
    <h3>Scanned Rolls:<br/>рд╕реНрдХреИрди рдХрд┐рдП рд░реЛрд▓</h3>
    <ul id="roll-list"></ul>
  </div>

  <!-- 6) Confirm Dispatch button -->
  <button id="confirm-dispatch" class="btn"
          style="display:none; margin-top:1rem;">
    Confirm Dispatch<br/>Dispatch рдкреБрд╖реНрдЯрд┐ рдХрд░реЗрдВ
  </button>

  <script>
    // Helper to strip UUID from URL or raw QR
    function parseRollId(s) {
      try {
        if (s.startsWith('http')) {
          return new URL(s).pathname.split('/').filter(Boolean).pop();
        }
      } catch {}
      return s.trim();
    }

    // State
    let mode = null;             // 'DISPATCH' or 'TRANSFER'
    let customer = null;
    let deptCode = null;
    let locationMode = false;    // only for TRANSFER flow
    const rolls = [];
    const csrf = window.CSRF_TOKEN;

    // DOM refs
    const custDiv   = document.getElementById('cust-div');
    const deptDiv   = document.getElementById('dept-div');
    const scanLocB  = document.getElementById('scan-location');
    const confirmB  = document.getElementById('confirm-dispatch');
    const rollList  = document.getElementById('roll-list');

    // 1) Action selection
    document.getElementById('to-customer').onclick = () => {
      mode = 'DISPATCH'; locationMode = false;
      customer = null;
      // show customer input, hide transfer controls
      custDiv.style.display = 'block';
      deptDiv.style.display = 'none';
      scanLocB.style.display = 'none';
      confirmB.style.display = 'none';
      // reset batch
      rolls.length = 0; rollList.innerHTML = '';
      speak('рдЧреНрд░рд╛рд╣рдХ рдХрд╛ рдирд╛рдо рджрд░реНрдЬ рдХрд░реЗрдВ');
    };
    document.getElementById('to-dept').onclick = () => {
      mode = 'TRANSFER'; locationMode = false;
      deptCode = null;
      custDiv.style.display = 'none';
      deptDiv.style.display = 'block';
      scanLocB.style.display = 'none';
      confirmB.style.display = 'none';
      rolls.length = 0; rollList.innerHTML = '';
      speak('рд╡рд┐рднрд╛рдЧ рдЪреБрдиреЗрдВ');
    };

    // 2a) Customer name entry
    document.getElementById('cust-input').oninput = e => {
      customer = e.target.value.trim();
      // only show confirm once we have at least one roll
      if (rolls.length) confirmB.style.display = 'block';
    };

    // 2b) Dept selection
    document.getElementById('dept-select').onchange = e => {
      deptCode = e.target.value;
      if (rolls.length) {
        scanLocB.style.display = 'block';
      }
    };

    // 3) decode handler
    async function handleDecode(raw) {
      const id = parseRollId(raw);
      // transfer: if in locationMode, treat as rack scan
      if (mode==='TRANSFER' && locationMode) {
        const location = parseRollId(raw);
        speak(`рд▓реЛрдХреЗрд╢рди ${location} рд╕реНрдХреИрди рдХрд┐рдпрд╛ рдЧрдпрд╛`);
        await qr.stop();
        // commit TRANSFER for each roll
        for (const r of rolls) {
          const res = await fetch('/api/transactions/', {
            method:'POST',
            credentials:'same-origin',
            headers:{
              'Content-Type':'application/json',
              'X-CSRFToken':csrf
            },
            body: JSON.stringify({
              roll: r,
              action: 'TRANSFER',
              location,
              user: window.CURRENT_USER
            })
          });
          if (!res.ok) {
            const err = await res.json().catch(()=>null);
            return alert(`тЭМ Error: ${JSON.stringify(err)}`);
          }
        }
        alert(`тЬЕ ${rolls.length} rolls transferred to ${deptCode} at ${location}.`);
        return location.reload();
      }

      // otherwise weтАЩre in batchтАРscan mode
      if (rolls.includes(id)) return;
      // verify roll
      const ok = await fetch(`/api/rolls/${id}/`).then(r=>r.ok);
      if (!ok) {
        return alert(`тЭМ Roll "${id}" not found.\nтЭМ рд░реЛрд▓ "${id}" рдирд╣реАрдВ рдорд┐рд▓рд╛ред`);
      }
      rolls.push(id);
      const li = document.createElement('li');
      li.textContent = id.slice(0,8); // keep the list compact
      rollList.appendChild(li);
      speak(`рд░реЛрд▓ ${id.slice(0,8)} рдЬреЛрдбрд╝рд╛`);

      // show the right next control
      if (mode==='DISPATCH') {
        if (customer) confirmB.style.display = 'block';
      } else if (mode==='TRANSFER') {
        if (deptCode) scanLocB.style.display = 'block';
      }
    }

    // 4) Kick off the camera
    const qr = new Html5Qrcode("reader");
    qr.start(
      { facingMode:'environment' },
      { fps:10, qrbox:250 },
      handleDecode
    ).catch(err => {
      console.error('dispatch scanner error', err);
      alert('рдХреГрдкрдпрд╛ рдХреИрдорд░рд╛ рдЕрдиреБрдорддрд┐ рджреЗрдВ');
    });

    // 5) Confirm Dispatch тЖТ post DISPATCH
    confirmB.onclick = async () => {
      if (!customer || !rolls.length) return;
      await qr.stop();
      for (const r of rolls) {
        const res = await fetch('/api/transactions/', {
          method:'POST',
          credentials:'same-origin',
          headers:{
            'Content-Type':'application/json',
            'X-CSRFToken':csrf
          },
          body: JSON.stringify({
            roll: r,
            action: 'DISPATCH',
            customer,
            user: window.CURRENT_USER
          })
        });
        if (!res.ok) {
          const err = await res.json().catch(()=>null);
          return alert(`тЭМ Error: ${JSON.stringify(err)}`);
        }
      }
      alert(`тЬЕ Dispatched ${rolls.length} rolls to ${customer}!`);
      location.reload();
    };

    // 6) Scan Location button тЖТ enter rack mode
    scanLocB.onclick = () => {
      if (!deptCode || !rolls.length) {
        return alert('тЪая╕П First scan rolls and select dept\nтЪая╕П рдкрд╣рд▓реЗ рд░реЛрд▓ рд╕реНрдХреИрди рдХрд░реЗрдВ рдФрд░ рд╡рд┐рднрд╛рдЧ рдЪреБрдиреЗрдВред');
      }
      locationMode = true;
      speak('рдХреГрдкрдпрд╛ рд▓реЛрдХреЗрд╢рди рд╕реНрдХреИрди рдХрд░реЗрдВ');
      alert('Now scan department location\nрдЕрдм рд╡рд┐рднрд╛рдЧ рд╕реНрдерд╛рди рд╕реНрдХреИрди рдХрд░реЗрдВ');
    };
    // 1) capture hardwareтАРscanner keystrokes
    let buffer = '';
    function handleKbd(evt) {
      if (evt.key.length === 1) buffer += evt.key;
      else if (evt.key === 'Enter' && buffer) {
        handleDecode(buffer);
        buffer = '';
        evt.preventDefault();
      }
    }

    // 2) show/hide camera vs keyboard
    const cameraEl = document.getElementById('reader');
    const kbdInput = document.getElementById('kbdтАРinput');
    function updateScannerUI(mode) {
      if (mode === 'camera') {
        cameraEl.style.display = 'block';
        document.removeEventListener('keydown', handleKbd);
      } else {
        cameraEl.style.display = 'none';
        buffer = '';
        kbdInput.focus();
        document.addEventListener('keydown', handleKbd);
      }
    }

    // init & listen for toggles
    updateScannerUI(localStorage.getItem('scanMode') || 'camera');
    window.addEventListener('scanModeChanged', e => updateScannerUI(e.detail));


  </script>
{% endblock %}
