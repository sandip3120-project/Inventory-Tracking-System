{% extends "mobile/base.html" %}
{% block content %}
  <script>
    document.getElementById('page-title').textContent = 'Scan & View';
    // speak may not exist immediately, guard it
    if (typeof speak === 'function') {
      speak('‡§ï‡•É‡§™‡§Ø‡§æ ‡§∞‡•ã‡§≤ ‡§Ø‡§æ ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•á‡§Ç');
    }
  </script>

  <p style="margin-bottom:1em; font-size:1rem; text-align:center;">
    Scan any Roll or Rack QR to view details<br/>
    ‡§ï‡§ø‡§∏‡•Ä ‡§∞‡•ã‡§≤ ‡§Ø‡§æ ‡§∞‡•à‡§ï QR ‡§ï‡•ã ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•á‡§Ç
  </p>
  <input id="kbd‚Äêinput" type="text" autocomplete="off"
    autocapitalize="off" autocorrect="off" spellcheck="false"
    style="position:absolute;top:-9999px;left:-9999px;"/>

  <div id="reader"></div>
  <div id="details" class="list"
       style="margin-top:1em; padding:1em; background:#fff; border-radius:8px;">
    <p>Ready to scan‚Ä¶</p>
  </div>

  <script>
    async function showDetails(raw) {
      console.log('üîç showDetails raw QR:', raw);
      let type, id;
      try {
        const url = new URL(raw);
        const parts = url.pathname.split('/').filter(Boolean);
        if (parts[0] === 'r') {
          type = 'roll'; id = parts[1];
        } else if (parts[0] === 'loc') {
          type = 'location'; id = parts[1];
        }
      } catch (err) {
        console.warn('üîç showDetails: not a URL', err);
      }

      const container = document.getElementById('details');
      container.innerHTML = '<p>Loading‚Ä¶</p>';

      if (type === 'roll') {
        const res = await fetch(`/api/rolls/${id}/`);
        if (!res.ok) {
          return container.innerHTML = `<p>Roll "${id}" not found.</p>`;
        }
        const d = await res.json();
        console.log('üîç DEBUG roll payload:', d);

        // format posting date
        const postDate = d.posting_date
          ? new Date(d.posting_date).toLocaleString()
          : '‚Äì';

        const statusLine = d.status || 'Yet to store or dispatch';

        container.innerHTML = `
          <h3>Roll ${d.roll_id}</h3>
          <p><strong>Material Number:</strong> ${d.material_number}</p>
          <p><strong>Description:</strong> ${d.description}</p>
          <p><strong>Batch Number:</strong> ${d.batch_number}</p>
          <p><strong>Weight:</strong> ${d.weight_kg}‚ÄØkg</p>
          <p><strong>Posting Date:</strong> ${postDate}</p>
          <p><strong>Status:</strong> ${statusLine}</p>
        `;
      }
      else if (type === 'location') {
        const res = await fetch(`/api/locations/${id}/rolls/`);
        if (!res.ok) {
          return container.innerHTML = `<p>Location "${id}" not found.</p>`;
        }
        const rolls = await res.json();
        container.innerHTML = `
          <h3>Location ${id}</h3>
          <p><strong>Total rolls:</strong> ${rolls.length}</p>
          <ul>${rolls.map(r => `<li><strong>${r.material_number}</strong> ‚Äì ${r.description}<br/>Batch: ${r.batch_number}<br/>Weight: ${r.weight_kg}‚ÄØkg<br/>Status: ${r.status}</li>`).join('')}
          </ul>
        `;
      }
      else {
        container.innerHTML = `<p>Unrecognized QR code.</p>`;
      }
    }

    new Html5Qrcode("reader")
      .start(
        { facingMode: 'environment' },
        { fps: 10, qrbox: 250 },
        showDetails
      )
      .then(() => console.log('üì∑ scanner started'))
      .catch(err => {
        console.error('‚ùå scan-view startup error', err);
        alert('Scanner error: ' + err);
      });
      // 1) capture hardware‚Äêscanner keystrokes
      let buffer = '';
      function handleKbd(evt) {
        if (evt.key.length === 1) buffer += evt.key;
        else if (evt.key === 'Enter' && buffer) {
          handleDecode(buffer);
          buffer = '';
          evt.preventDefault();
        }
      }

      // 2) show/hide camera vs keyboard
      const cameraEl = document.getElementById('reader');
      const kbdInput = document.getElementById('kbd‚Äêinput');
      function updateScannerUI(mode) {
        if (mode === 'camera') {
          cameraEl.style.display = 'block';
          document.removeEventListener('keydown', handleKbd);
        } else {
          cameraEl.style.display = 'none';
          buffer = '';
          kbdInput.focus();
          document.addEventListener('keydown', handleKbd);
        }
      }

      // init & listen for toggles
      updateScannerUI(localStorage.getItem('scanMode') || 'camera');
      window.addEventListener('scanModeChanged', e => updateScannerUI(e.detail));



  </script>
{% endblock %}